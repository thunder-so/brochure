---
import { ChevronDown, ChevronRight } from "lucide-astro";
import { cn } from "@/lib/utils";
import { sidebar } from '../../content/config';

interface Props {
  currentPage: string;
  class?: string;
}

const { currentPage, class: className } = Astro.props;

// Helper to normalize paths for comparison
const normalizePath = (path: string) => path.replace(/^\/|\/$/g, '');
const currentPath = normalizePath(currentPage);

// Group sidebar items by category/header
const sections = Object.entries(sidebar).map(([title, items]) => ({
  title,
  items
}));
---

<nav class={cn("w-64 shrink-0 hidden lg:block", className)}>
  <div class="sticky top-24 max-h-[calc(100vh-6rem)] overflow-y-auto pr-4">
    {sections.map((section) => {
        // Check if any item in this section is active to set initial open state
        const isSectionActive = section.items.some(item => normalizePath(item.link) === currentPath);
        
        return (
            <div class="mb-6 sidebar-section" data-active={isSectionActive}>
                <button
                    class="section-toggle flex items-center justify-between w-full text-xs font-semibold uppercase tracking-wider text-muted-foreground hover:text-foreground transition-colors mb-2"
                >
                    {section.title}
                    <ChevronDown class="h-3.5 w-3.5 icon-open" />
                    <ChevronRight class="h-3.5 w-3.5 icon-closed hidden" />
                </button>
                <ul class="section-items space-y-1">
                    {section.items.map((item) => {
                        const isActive = normalizePath(item.link) === currentPath;
                        return (
                            <li>
                                <div class="flex items-center">
                                    <a
                                        href={`/${item.link}`}
                                        class={cn(
                                            "flex-1 py-1.5 px-2 text-sm rounded-md transition-colors",
                                            isActive
                                                ? "bg-primary/10 text-primary font-medium"
                                                : "text-muted-foreground hover:text-foreground hover:bg-muted"
                                        )}
                                    >
                                        {item.text}
                                    </a>
                                </div>
                            </li>
                        );
                    })}
                </ul>
            </div>
        )
    })}
  </div>
</nav>

<script>
    // Simple toggle functionality for sidebar sections
    const sections = document.querySelectorAll('.sidebar-section');
    
    sections.forEach(section => {
        const toggle = section.querySelector('.section-toggle');
        const items = section.querySelector('.section-items');
        const iconOpen = section.querySelector('.icon-open');
        const iconClosed = section.querySelector('.icon-closed');
        
        toggle?.addEventListener('click', () => {
            items?.classList.toggle('hidden');
            iconOpen?.classList.toggle('hidden');
            iconClosed?.classList.toggle('hidden');
        });
        
        // Initial state based on data-active attribute is handled by Astro server-side rendering logic above,
        // but if we want to default to open we can leave as is. 
        // If we want closed by default unless active, we'd add logic here or in the class list above.
        // For now, let's keep all open by default as per the React component's behavior if no state logic was complex.
        // Actually, looking at the React code: `const [isOpen, setIsOpen] = useState(isActive);`
        // So it opens if active.
        
        // Let's adjust the initial state in the DOM based on `data-active`
        if (section.getAttribute('data-active') !== 'true') {
             // If you want non-active sections to be collapsed by default, uncomment below:
             // items?.classList.add('hidden');
             // iconOpen?.classList.add('hidden');
             // iconClosed?.classList.remove('hidden');
        }
    });
</script>
